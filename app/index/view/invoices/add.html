<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>發票</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    {include file="public:head" /}
    
    <!-- jQuery -->
    {js href="__PLUGIN__/jquery/jquery.min.js" /}
    {js href="__PLUGIN__/layer/layer.js" /}
    <!-- Bootstrap Table -->
    {css href="__PLUGIN__/bootstrap-table/bootstrap-table.min.css" /}
    {js href="__PLUGIN__/bootstrap-table/bootstrap-table.min.js" /}
    <!-- Bootstrap 4 -->
    {js href="__PLUGIN__/bootstrap/js/bootstrap.bundle.min.js" /}
    {js href="__PLUGIN__/moment/moment.min.js" /}
    {js href="__PLUGIN__/daterangepicker/daterangepicker.js" /}
    {js href="__JS__/adminlte.min.js" /}
    {js href="__JS__/init.js" /}
    {js href="__JS__/application.js" /}

    <!-- 加载 Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/js/select2.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Theme style -->
    {css href="__CSS__/adminlte.min.css" /}
    {css href="__PLUGIN__/daterangepicker/daterangepicker.css" /}
    <!-- Ionicons -->
    {css href="__PLUGIN__/icon-awesome/css/font-awesome.min.css" / }
    {css href="__CSS__/ionicons.min.css" /}
    <!-- Custom style -->
    {css href="__CSS__/application.css" /}

    <style type="text/css">
        .form-control{
            padding: .375rem;
        }   

        #final_total_text{
            border: 3px solid #ced4da; 
            height: 70px; 
            line-height: 70px; 
            text-align: center; 
            font-size: 1.25rem; 
            font-weight: bold;
        } 
    </style>
</head>
<body>
    <div class="container-fluid">
        <form id="invoiceForm">
            <input type="hidden" name="id" id="id" value="{$data.id|default='0'}">
            <input type="hidden" name="booking_id" id="booking_id" value="{$booking_id|default='0'}">
            <input type="hidden" name="from" id="from" value="{$from|default=''}">
            <div class="card-body">
                <div class="row pt-2">
                    <div class="col-xs-12 col-md-6">
                        <h5 class="text-primary">發票資料</h5>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="code">編號：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="text" id="code" name="code" value="{$data.code|default=''}">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="invoice_date">日期：</label>
                            <div class="col-md-7">
                                <input type="datetime" class="form-control filed-date" id="invoice_date" name="invoice_date" value="{$data.invoice_date|default=''}" required>                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="store_id">店鋪：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="hidden" id="store_id" name="store_id" value="{$data.store_id|default=''}" required>
                                <input class="form-control" type="text" id="store_name" name="store_name" value="{$data.store_name|default=''}" readonly="">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="invoice_date">銷售員：</label>
                            <div class="col-md-7">
                                <a title="選擇銷售員" onclick="sellers()" class="btn btn-primary btn-sm " href="#">選擇</a>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label"></label>
                            <div class="col-md-7">
                                <div class="consultant"></div>
                                <div class="beautician">
                                    {notempty name="inv_sellers"}
                                    {volist name="inv_sellers" id="val" key="index"}
                                        <div class="seller">
                                            <input type="hidden" class="sellers" value="{$val.seller_id}">
                                            <input type="hidden" name="seller[{$index}][id]" value="{$val.id}">
                                            <input type="hidden" name="seller[{$index}][invoice_id]" value="{$val.invoice_id}">
                                            <input type="hidden" name="seller[{$index}][seller_id]" value="{$val.seller_id}">{$val.seller_name}
                                        </div>
                                    {/volist}
                                    {/notempty}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-12 col-md-6">
                        <h5 class="text-primary">會員資料</h5>

                        <div class="form-group row">
                            <div class="col-md-3">
                                <a class="btn btn-default" onclick="new_member()" href="#">新增會員</a>
                            </div>
                            <div class="col-md-7">
                                <input type="checkbox" name="new_customer" {if condition="isset($data.new_customer) && $data.new_customer = 1"} checked="" {/if} value="1">新客
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="member_id">編號：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="hidden" id="member_id" name="member_id" value="{$member.id|default='0'}" required>
                                <input class="form-control" type="text" id="member_no" value="{$member.member_no|default=''}" required>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="name">名稱：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="text" id="name" value="{$member.first_name|default=''}" readonly="">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="phone">電話：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="text" id="phone" value="{$member.phone_mobile|default=''}" readonly="">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="store">儲值：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="text" id="store" value="{$member.store|default='0.0'}" readonly="">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="reward">獎賞：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="text" id="reward" value="{$member.reward|default='0.0'}" readonly="">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row pt-2">
                    <div class="col-xs-12 col-md-8">
                       
                        <table width="100%">
                            <tr bgcolor="#ced4da">
                                <td width="8%">
                                    <a title="刪除" onclick="del()" class="btn btn-default btn-sm " href="#">刪除</a>
                                </td>
                                <td colspan="7">
                                    <a title="服務套票" onclick="service_packages()" class="btn btn-default btn-sm " href="#">服務套票</a>
                                    <a title="產品" onclick="products()" class="btn btn-default btn-sm " href="#">產品</a>
                                    <a title="組合產品" onclick="combinations()" class="btn btn-default btn-sm " href="#">組合產品</a>
                                    <input type="hidden" name="total" id="total" value="{$data.total|default='0.0'}">
                                    <input type="hidden" class="items_count" value="{$data.items_count|default='0'}">
                                </td>
                            </tr>
                            
                            <tr bgcolor="#e9ecef">
                                <th width="8%"></th>
                                <th width="5%"></th>
                                <th width="13%">編號</th>
                                <th width="28%">名稱</th>
                                <th width="10%">數量</th>
                                <th width="13%">單價</th>
                                <th width="10%">折扣</th>
                                <th width="13%">金額</th>
                            </tr>

                            <tr bgcolor="#ced4da" id="service_package" {empty name="inv_items.service_packages"} class="hidden" {/empty}>
                                <td colspan="8" class="border-b-double">
                                    <label>服務套票</label>
                                </td>
                            </tr>

                            {notempty name="inv_items.service_packages"}
                            {volist name="inv_items.service_packages" id="val"}
                                <tr class="border-b service"> 
                                    <td width="8%" align="center" data-id="{$val.id}">
                                        <input type="checkbox" class="checkbox" value="{$val.index}">
                                        <input type="hidden" class="service_packages" value="{$val.service_id}">
                                    </td> 
                                    <td width="5%"> 
                                        <input type="hidden" name="service[{$val.index}][id]" value="{$val.id}"> 
                                        <input type="hidden" name="service[{$val.index}][invoice_id]" value="{$val.invoice_id}"> 
                                        <input type="hidden" name="service[{$val.index}][service_id]" value="{$val.service_id}"> 
                                        <input type="hidden" name="service[{$val.index}][service_type]" value="{$val.service_type}">
                                        <input type="hidden" class="package_value" name="service[{$val.index}][package_value]" value="{$val.package_value}">
                                        <input type="hidden" name="service[{$val.index}][package_unit]" value="{$val.package_unit}">
                                        <i class="fa fa-plus-square-o collaps"></i>
                                    </td>
                                    <td width="13%">{$val.code}</td> 
                                    <td width="28%">{$val.name}</td> 
                                    <td width="10%">
                                        <input type="number" min="1" name="service[{$val.index}][quantity]" value="{$val.quantity}" class="form-control text-right quantity" style="width: 100%;">
                                        <input type="hidden" name="service[{$val.index}][package_original_value]" class="package_original_value" value="{$val.package_original_value}">
                                    </td>
                                    <td width="13%">
                                        <input type="text" name="service[{$val.index}][price]" value="{$val.price}" class="form-control text-right price" style="width: 100%;">
                                    </td> 
                                    <td width="10%">
                                        <input type="text" name="service[{$val.index}][discount]" value="{$val.discount}" class="form-control text-right discount" style="width: 100%;">
                                    </td> 
                                    <td width="13%">
                                        <input type="text" name="service[{$val.index}][total]" value="{$val.total}" class="form-control text-right total" style="width: 100%;" readonly="">
                                    </td> 
                                </tr>

                            <tr class="border-b change hidden" id="table{$val.index}">
                                <td colspan="3"></td>
                                <td colspan="5">
                                    <table width="100%">
                                        <tr bgcolor="#ced4da">
                                            <td colspan="8">
                                                <a title="刪除" onclick="del_transfer()" class="btn btn-default btn-sm " href="#">刪除</a>
                                                <a title="服務套票" onclick="transfer_packages('{$val.index}')" class="btn btn-default btn-sm " href="#">轉套票</a>
                                                {if isset($val.transfer)}
                                                    <input type="hidden" class="item_count{$val.index}" value="{:count($val.transfer)}">
                                                {else /}
                                                    <input type="hidden" class="item_count{$val.index}" value="0">
                                                {/if}
                                            </td>
                                        </tr>
                                        <tr bgcolor="#e9ecef">
                                            <th width="10%"></th>
                                            <th width="15%">編號</th>
                                            <th width="30%">名稱</th>
                                            <th width="15%">轉套票值</th>
                                            <th width="15%">平均</th>
                                            <th width="15%">減免金額</th>
                                        </tr>

                                        {notempty name="val.transfer"}
                                        {volist name="val.transfer" id="va" key="k"}
                                        <tr class="border-b">
                                            <td width="10%" align="center" data-id="{$va.id}">
                                                <input type="checkbox" class="transfer_checkbox" value="{$k}" data-idx="{$val.index}">
                                                <input type="hidden" class="transfer_packages{$val.index}" value="{$va.old_invoice_item_id}">
                                                <input type="hidden" name="service[{$val.index}][transfer][{$k}][id]" value="{$va.id}">
                                                <input type="hidden" name="service[{$val.index}][transfer][{$k}][new_invoice_id]" value="{$va.new_invoice_id}">
                                                <input type="hidden" name="service[{$val.index}][transfer][{$k}][new_invoice_item_id]" value="{$va.new_invoice_item_id}">
                                                <input type="hidden" name="service[{$val.index}][transfer][{$k}][old_invoice_id]" value="{$va.old_invoice_id}">
                                                <input type="hidden" name="service[{$val.index}][transfer][{$k}][old_invoice_item_id]" value="{$va.old_invoice_item_id}">
                                            </td>
                                            <td width="15%">{$va.code}</td>
                                            <td width="30%">{$va.name}</td>
                                            <td width="15%">
                                                <input type="text" name="service[{$val.index}][transfer][{$k}][transfer_value]" value="{$va.transfer_value}" class="form-control form-control-sm text-right transfer_value" data-max="{$va.max_value}" data-idx="{$val.index}" style="width: 100%;">
                                            </td>
                                            <td width="15%">
                                                <input type="text" name="service[{$val.index}][transfer][{$k}][package_avg]" value="{$va.package_avg}" class="form-control form-control-sm text-right package_avg" style="width: 100%;" readonly="">
                                            </td>
                                            <td width="15%">
                                                <input type="text" name="service[{$val.index}][transfer][{$k}][deduction]" value="{$va.deduction}" class="form-control form-control-sm text-right deduction{$val.index}" data-max="{$va.max_deduction}" style="width: 100%;" readonly="">
                                            </td>
                                        </tr>
                                        {/volist}
                                        {/notempty}

                                        <tr class="deduction" id="deduction{$val.index}">
                                            <td colspan="8" class="text-right">{$val.deduction|default='0.0'}</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            {/volist}
                            {/notempty}

                            <tr bgcolor="#ced4da" id="product" {empty name="inv_items.products"} class="hidden" {/empty}>
                                <td colspan="8" class="border-b-double">
                                    <label>產品</label>
                                </td>
                            </tr>

                            {notempty name="inv_items.products"}
                            {volist name="inv_items.products" id="val"}
                                <tr class="border-b service"> 
                                    <td width="8%" align="center" data-id="{$val.id}">
                                        <input type="checkbox" class="checkbox" value="{$val.index}">
                                        <input type="hidden" class="products" value="{$val.service_id}">
                                    </td> 
                                    <td width="5%"> 
                                        <input type="hidden" name="service[{$val.index}][id]" value="{$val.id}"> 
                                        <input type="hidden" name="service[{$val.index}][invoice_id]" value="{$val.invoice_id}"> 
                                        <input type="hidden" name="service[{$val.index}][service_id]" value="{$val.service_id}"> 
                                        <input type="hidden" name="service[{$val.index}][service_type]" value="{$val.service_type}"> 
                                    </td> 
                                    <td width="13%">{$val.code}</td> 
                                    <td width="28%">{$val.name}</td> 
                                    <td width="10%">
                                        <input type="number" min="1" name="service[{$val.index}][quantity]" value="{$val.quantity}" class="form-control text-right quantity" style="width: 100%;">
                                    </td> 
                                    <td width="13%">
                                        <input type="text" name="service[{$val.index}][price]" value="{$val.price}" class="form-control text-right price" style="width: 100%;">
                                    </td> 
                                    <td width="10%">
                                        <input type="text" name="service[{$val.index}][discount]" value="{$val.discount}" class="form-control text-right discount" style="width: 100%;">
                                    </td> 
                                    <td width="13%">
                                        <input type="text" name="service[{$val.index}][total]" value="{$val.total}" class="form-control text-right total" style="width: 100%;" readonly="">
                                    </td> 
                                </tr>
                            {/volist}
                            {/notempty}

                            <tr bgcolor="#ced4da" id="combination" {empty name="inv_items.combinations"} class="hidden" {/empty}>
                                <td colspan="8" class="border-b-double">
                                    <label>產品組合</label>
                                </td>
                            </tr>

                            {notempty name="inv_items.combinations"}
                            {volist name="inv_items.combinations" id="val"}
                                <tr class="border-b service"> 
                                    <td width="8%" align="center" data-id="{$val.id}">
                                        <input type="checkbox" class="checkbox" value="{$val.index}">
                                        <input type="hidden" class="combinations" value="{$val.service_id}">
                                    </td> 
                                    <td width="5%"> 
                                        <input type="hidden" name="service[{$val.index}][id]" value="{$val.id}"> 
                                        <input type="hidden" name="service[{$val.index}][invoice_id]" value="{$val.invoice_id}"> 
                                        <input type="hidden" name="service[{$val.index}][service_id]" value="{$val.service_id}"> 
                                        <input type="hidden" name="service[{$val.index}][service_type]" value="{$val.service_type}"> 
                                    </td> 
                                    <td width="13%">{$val.code}</td> 
                                    <td width="28%">{$val.name}</td> 
                                    <td width="10%">
                                        <input type="number" min="1" name="service[{$val.index}][quantity]" value="{$val.quantity}" class="form-control text-right quantity" style="width: 100%;">
                                    </td> 
                                    <td width="13%">
                                        <input type="text" name="service[{$val.index}][price]" value="{$val.price}" class="form-control text-right price" style="width: 100%;">
                                    </td> 
                                    <td width="10%">
                                        <input type="text" name="service[{$val.index}][discount]" value="{$val.discount}" class="form-control text-right discount" style="width: 100%;">
                                    </td> 
                                    <td width="13%">
                                        <input type="text" name="service[{$val.index}][total]" value="{$val.total}" class="form-control text-right total" style="width: 100%;" readonly="">
                                    </td> 
                                </tr>
                            {/volist}
                            {/notempty}

                            <tr bgcolor="#ced4da" id="member">
                                <td colspan="8" class="border-b-double">
                                    <label>會員增值</label>
                                </td>
                            </tr>

                            <tr bgcolor="#e9ecef">
                                <td width="8%"></td>
                                <td width="5%"></td>
                                <td width="13%"></td>
                                <td width="28%">儲值</td>
                                <td width="10%"></td>
                                <td width="13%">
                                    <input class="form-control" id="member_store" type="text" name="member_store" value="{$data.member_store|default='0.0'}" style="width: 100%; text-align: right;">
                                </td>
                                <td width="10%"></td>
                                <td width="13%">
                                    <span class="member_store">{$data.member_store|default='0.0'}</span>
                                </td>
                            </tr>

                            <tr bgcolor="#e9ecef">
                                <td width="8%"></td>
                                <td width="5%"></td>
                                <td width="13%"></td>
                                <td width="28%">獎賞</td>
                                <td width="10%"></td>
                                <td width="13%">
                                    <input class="form-control member_reward" type="text" name="member_reward" value="{$data.member_reward|default='0.0'}" style="width: 100%; text-align: right;">
                                </td>
                                <td width="10%"></td>
                                <td width="13%"></td>
                            </tr>

                            <tr>
                                <td width="8%"></td>
                                <td width="5%"></td>
                                <td width="13%"></td>
                                <td width="28%"></td>
                                <td width="10%"></td>
                                <td width="13%"></td>
                                <td width="10%"></td>
                                <td width="13%"></td>
                            </tr>

                            <tr>
                                <td colspan="2">
                                    <label class="control-label">備注：</label>
                                </td>
                                
                                <td colspan="4">
                                    <textarea class="form-control" name="notes" id="notes">{$data.notes|default=''}</textarea>
                                </td>
                                <td>
                                    <a title="選擇備注" onclick="notes()" class="btn btn-primary btn-sm" href="#">選擇</a>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div class="col-xs-12 col-md-4">
                        <div class="border">
                            <input type="hidden" name="final_total" id="final_total" value="{$data.final_total|default='0.0'}">
                            <div id="final_total_text">
                                {if condition="isset($data.final_total) && $data.final_total > 0"}
                                    尚欠：${$data.final_total}
                                {elseif isset($data.final_total) && $data.final_total < 0/}
                                    找贖：${:abs($data.final_total)}
                                {/if}
                            </div>
                            <div class="total_amount d-flex justify-content-between g-mb-20 g-pa-5">
                                <span>總金額：</span>
                                <strong><h5 id="h5">${$data.total_amount|default='0.0'}</h5></strong>
                                <input type="hidden" name="total_amount" id="total_amount" value="{$data.total_amount|default='0.0'}">
                                
                            </div>

                            <div class="row g-pa-5">
                                <label class="col-md-7">付款方式：</label>
                                <label class="col-md-5">現付金額：</label>
                            </div>

                            <div class="row g-pa-5">
                                <div class="col-md-7">
                                    <input type="hidden" name="payment[0][id]" value="{$inv_payments[0]['id']|default=''}">
                                    <input type="hidden" name="payment[0][invoice_id]" value="{$inv_payments[0]['invoice_id']|default=''}">
                                    <select class="form-control method1" name="payment[0][method]" style="display: none; width: 100%;">
                                        <option value="{$inv_payments[0]['method']|default=''}">{$inv_payments[0]['payment_method']|default=''}</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <input type="text" name="payment[0][amount]" class="form-control text-right payment_amount amount1" value="{$inv_payments[0]['amount']|default=''}">
                                </div>
                            </div>
                            <div class="row g-pa-5">
                                <div class="col-md-7">
                                    <input type="hidden" name="payment[1][id]" value="{$inv_payments[1]['id']|default=''}">
                                    <input type="hidden" name="payment[1][invoice_id]" value="{$inv_payments[1]['invoice_id']|default=''}">
                                    <select class="form-control method2" name="payment[1][method]" style="display: none; width: 100%;">
                                        <option value="{$inv_payments[1]['method']|default=''}">{$inv_payments[1]['payment_method']|default=''}</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <input type="text" name="payment[1][amount]" class="form-control text-right payment_amount amount2" value="{$inv_payments[1]['amount']|default=''}">
                                </div>
                            </div>
                            <div class="row g-pa-5">
                                <div class="col-md-7">
                                    <input type="hidden" name="payment[2][id]" value="{$inv_payments[2]['id']|default=''}">
                                    <input type="hidden" name="payment[2][invoice_id]" value="{$inv_payments[2]['invoice_id']|default=''}">
                                    <select class="form-control method3" name="payment[2][method]" style="display: none; width: 100%;">
                                        <option value="{$inv_payments[2]['method']|default=''}">{$inv_payments[2]['payment_method']|default=''}</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <input type="text" name="payment[2][amount]"  class="form-control text-right payment_amount amount3" value="{$inv_payments[2]['amount']|default=''}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xs-12 col-md-12 col-lg-12">
                    <div class="row pt-2">
                        <div class="col-lg-12" align="center">
                            <button class="btn flat btn-info btn-sm submit">
                                <i class=" fa fa-file-alt"></i>
                                存儲
                            </button>

                            <button class="btn btn-default btn-sm btn-close">
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</body>   
<script type="text/javascript">
    function del(){
        let id = 0;
        let list = [];
        $(".checkbox:checked").each(function(){
            id = $(this).parent('td').attr('data-id');

            if(id){
                list.push(id);
            }

            $(this).parents('tr').remove();

        })
        if(list.length > 0){
            $.ajax({
                url: "{:url('del_item')}",
                data: {ids: list},
                type: "POST",
                success(res){
                    
                    total();
                }
            })
        }
    }

    function del_transfer(){
        let id = 0,
            idx,
            deduction = 0.0,
            total_deduction = 0.0;
        let list = [];
        $(".transfer_checkbox:checked").each(function(){
            id = $(this).parent('td').attr('data-id');
            idx = $(this).attr('data-idx');

            if(id){
                list.push(id);
            }

            $(this).parent('td').parent('tr').remove();

            deduction = parseFloat($(this).parent('td').siblings('td').find('.deduction'+idx).val());
            total_deduction = parseFloat($('#deduction'+idx).find('td').text());
            total_deduction -= deduction;
            $("#deduction" + idx).find('td').text(total_deduction.toFixed(1));
            total();
        });

        if(list.length > 0){
            $.ajax({
                url: "{:url('del_transfer')}",
                data: {ids: list},
                type: "POST",
                success(res){
                    layer.msg('success');
                }
            })
        }
    }

    function new_member(){
        let url = "{:url('members/add')}";

        let index = parent.layer.getFrameIndex(window.name); //获取窗口索引
        parent.layer.close(index);

        parent.location.href = url;
    }

    function sellers(){
        let ids = [];
        $(".sellers").each(function(){
            ids.push($(this).val());
        });

        layer.open({
            type: 2,
            title: '銷售員',
            area: ['800px', '500px'],
            content: '{:url("users/users?from_panel=invoices&ids=")}' + ids
        })
    }

    function notes(){
        layer.open({
            type: 2,
            title: '備注',
            area: ['800px', '500px'],
            content: '{:url("mappings/mappings?from_panel=invoices&type_id=notes")}'
        })
    }

    function service_packages(){
        let ids = [];
        $(".service_packages").each(function(){
            ids.push($(this).val());
        });
        // alert(ids);

        layer.open({
            type: 2,
            title: '服務套票',
            area: ['90%', '80%'],
            content: '{:url("service_packages/service_packages?from_panel=invoices&ids=")}' + ids
        })
    }

    function transfer_packages(index){
        let ids = [];
        $(".transfer_packages"+index).each(function(){
            ids.push($(this).val());
        });
        // alert(ids);
        let member_id = $("#member_id").val();
        let invoice_id = $("#id").val();

        layer.open({
            type: 2,
            title: '轉套票',
            maxmin: true,
            area: ['90%', '80%'],
            content: '{:url("invoices/service_packages?ids=")}' + ids + '&index=' + index + '&member_id=' + member_id + '&invoice_id=' + invoice_id
        })
    }

    function products(){
        let ids = [];
        $(".products").each(function(){
            ids.push($(this).val());
        });
        // alert(ids);
        layer.open({
            type: 2,
            title: '產品',
            area: ['90%', '80%'],
            content: '{:url("products/products?from_panel=invoices&ids=")}' + ids
        })
    }

    function combinations(){
        let ids = [];
        $(".combinations").each(function(){
            ids.push($(this).val());
        });
        // alert(ids);
        layer.open({
            type: 2,
            title: '產品組合',
            area: ['90%', '80%'],
            content: '{:url("combinations/combinations?from_panel=invoices&ids=")}' + ids
        })
    }


    //計算轉套票總值
    function deduction(idx) {
        let transfer_value, package_avg, deduction, max_value, max_deduction;
        let total_deduction = 0.0;

        $(".deduction"+idx).each(function () {
            transfer_value = parseFloat($(this).parent().siblings().children('.transfer_value').val());
            max_value = parseFloat($(this).parent().siblings().children('.transfer_value').attr('data-max'));
            package_avg = parseFloat($(this).parent().siblings().children('.package_avg').val());
            max_deduction = parseFloat($(this).attr('data-max'));
            // console.log(transfer_value, max_value, package_avg, max_deduction);

            if (transfer_value < max_value) {
                deduction = transfer_value * package_avg;
                $(this).val(parseFloat(deduction).toFixed(1));
            } else {
                if (transfer_value > max_value) {
                    layer.msg("不能超出套票剩餘值");
                }
                $(this).parent().siblings().children('.transfer_value').val(parseFloat(max_value).toFixed(1));
                $(this).val(parseFloat(max_deduction).toFixed(1));
                deduction = max_deduction;
            }


            total_deduction += parseFloat(deduction);
        });

        $("#deduction" + idx).find('td').text(total_deduction.toFixed(1));

        total();
    }

    //計算服務套票、產品、產品組合總價
    function total(){
        let amount = 0.0;
        let total = 0.0;
        let quantity, price, discount, deduction;
        $(".total").each(function () {

            quantity = parseFloat($(this).parent().siblings().children('.quantity').val());
            price = parseFloat($(this).parent().siblings().children('.price').val());
            discount = parseFloat($(this).parent().siblings().children('.discount').val());
            // console.log(quantity+', '+price+', '+discount);

            amount = parseFloat(price * quantity - discount);
            total += parseFloat(amount);

            $(this).val(amount.toFixed(1));
        });

        $(".deduction").each(function () {
            deduction = parseFloat($(this).find('td').text());
            // console.log(deduction);
            // console.log(total);

            total -= deduction;
        });
        // console.log(total);

        $("#total").val(total.toFixed(1));

        total_amount();
    }

    //計算應付總價
    function total_amount(){
        let total_amount = 0.0;
        let final_total = 0.0;

        // //可抵扣
        // let store = parseFloat($("#store").val());
        // let reward = parseFloat($("#reward").val());

        //需支付
        let total = parseFloat($("#total").val());
        let member_store = parseFloat($("#member_store").val());

        total_amount = parseFloat(total + member_store);
        final_total = total_amount;

        // //獎賞 > 應付
        // if(reward > final_total){
        //     final_total = 0.0;
        //     reward -= final_total;
        // //獎賞 < 應付
        // }else{
        //     final_total -= reward;
        //     reward = 0.0;
        //     //儲值 > 應付
        //     if (store > final_total) {
        //         final_total = 0.0;
        //         store -= final_total;
        //     //儲值 < 應付
        //     }else{
        //         final_total -= store;
        //         store = 0.0;
        //     }
        // }
        $("#final_total").val(final_total.toFixed(1));
        $("#final_total_text").text('應付：$'+final_total.toFixed(1));

        $("#total_amount").val(total_amount.toFixed(1));
        $("#h5").text('$'+total_amount.toFixed(1));

        payment_amount();
    }

    //計算剩余待支付金額
    function payment_amount(){
        let amount1 = $(".amount1").val();
        let amount2 = $(".amount2").val();
        let amount3 = $(".amount3").val();
        let total_amount = $("#total_amount").val();
        // console.log(amount1+', '+amount2+', '+amount3+', '+total_amount);
        let amount = 0.0;


        if (amount1) {
            amount1 = parseFloat(amount1);
        }else{
            amount1 = 0.0;
        }

        if (amount2) {
            amount2 = parseFloat(amount2);
        }else{
            amount2 = 0.0;
        }

        if (amount3) {
            amount3 = parseFloat(amount3);
        }else{
            amount3 = 0.0;
        }

        amount = parseFloat(amount1 + amount2 + amount3);

        total_amount = total_amount - amount;
        if (total_amount > 0) {
            $("#final_total").val(total_amount.toFixed(1));
            $("#final_total_text").text('尚欠：$'+total_amount.toFixed(1));
        }
        else if (total_amount < 0) {
            $("#final_total").val(total_amount.toFixed(1));
            $("#final_total_text").text('找贖：$'+Math.abs(total_amount).toFixed(1));
        }
        else if (total_amount == 0) {
            $("#final_total").val(total_amount.toFixed(1));
            $("#final_total_text").text('');
        }
    }

    $(document).ready( function (){
        initPaymentMethod();
        function initPaymentMethod(){
            $.ajax({
                url: "{:url('mappings/option')}",
                data: {type_id: 'payment_method'},
                dataType: 'json',
                success(res){
                    $(".method1").select2({
                        placeholder: "请选择", //默认input 文字
                        data: res.results,
                    })
                    $(".method2").select2({
                        placeholder: "请选择", //默认input 文字
                        data: res.results,
                    })
                    $(".method3").select2({
                        placeholder: "请选择", //默认input 文字
                        data: res.results,
                    })
                }
            })
        }

        $("#invoice_date").daterangepicker({
            "singleDatePicker": true,
            "timePicker": true,
            "timePicker24Hour": true,
            "timePickerSeconds": true,
            "startDate": $("#invoice_date").val() ? $("#invoice_date").val() : moment().format("YYYY-MM-DD HH:mm:ss"),
            "locale": {
                "format": "YYYY-MM-DD HH:mm:ss",
            }
        }).on('apply.daterangepicker', function(ev, picker) {
            // console.log(picker.startDate.format('YYYY-MM-DD HH:mm:ss'));
            $("#invoice_date").val(picker.startDate.format('YYYY-MM-DD HH:mm:ss'))
        });

        $(document).on("input propertychange", "#member_no", function () {
            let member_no = $(this).val();
            $.ajax({
                url: "{:url('members/find_member')}",
                data: {member_no: member_no},
                success(res){
                    if(res.member){
                        let member = res.member;
                        $("#member_id").val(member.id);
                        $("#member_no").val(member.member_no);
                        $("#name").val(member.first_name);
                        $("#phone").val(member.phone_mobile);
                    }
                }
            })
        });
        

        $(document).on("input propertychange", ".quantity", function () {
            total();
        });
        $(document).on("input propertychange", ".price", function () {
            total();
        });
        $(document).on("input propertychange", ".discount", function () {
            total();
        });
        $(document).on("input propertychange", ".transfer_value", function () {
            let idx = $(this).attr('data-idx');
            deduction(idx);
        });
        
        $(document).on("input propertychange", ".payment_amount", function () {
            payment_amount();   
        });

        $(document).on("input propertychange", "#member_store", function () {
            total_amount();
        });

        
        $(".submit").click(function(){
            let final_total = $("#final_total").val();
            if (final_total > 0) {
                layer.msg('請付清賬單！');
                return false;
            }

            let url = '{:url("invoices/add")}';

            let id = $("#id").val();
            if (id > 0) {
                url = '{:url("invoices/edit?id=")}' + id
            }

            let params = $("#invoiceForm").serialize();  
            
            $.ajax({
                url: url,
                data: params,
                type: "POST",
                success(res){
                    if(res.code == 200){
                        let from = $("#from").val();

                        if (from == 'booking'){
                            parent.layer.msg('success');
                            parent.location.reload();

                        }else{
                            parent.$('#invoices-grid').bootstrapTable('refresh');

                        }
                        //注意：parent 是 JS 自带的全局对象，可用于操作父页面
                        let index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                        parent.layer.close(index);
                    }
                }
            })
        });

        $(".btn-close").click(function(){
            let index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
        });

        $(document).on('click', '.collaps', function () {
            if ($(this).hasClass("fa-plus-square-o")) {
                $(this).removeClass("fa-plus-square-o").addClass("fa-minus-square-o");
                $(this).parents('tr').next('.change').removeClass('hidden');
            } else {
                $(this).removeClass("fa-minus-square-o").addClass("fa-plus-square-o");
                $(this).parents('tr').next('.change').addClass('hidden');
            }
        })
    })
</script>
</html>