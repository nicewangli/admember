<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>發票</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    {include file="public:head" /}
    
    <!-- jQuery -->
    {js href="__PLUGIN__/jquery/jquery.min.js" /}
    {js href="__PLUGIN__/layer/layer.js" /}
    <!-- Bootstrap Table -->
    {css href="__PLUGIN__/bootstrap-table/bootstrap-table.min.css" /}
    {js href="__PLUGIN__/bootstrap-table/bootstrap-table.min.js" /}
    <!-- Bootstrap 4 -->
    {js href="__PLUGIN__/bootstrap/js/bootstrap.bundle.min.js" /}
    {js href="__PLUGIN__/moment/moment.min.js" /}
    {js href="__PLUGIN__/daterangepicker/daterangepicker.js" /}
    {js href="__JS__/adminlte.min.js" /}
    {js href="__JS__/init.js" /}
    {js href="__JS__/application.js" /}

    <!-- 加载 Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/js/select2.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Theme style -->
    {css href="__CSS__/adminlte.min.css" /}

    <!-- Ionicons -->
    {css href="__PLUGIN__/icon-awesome/css/font-awesome.min.css" / }
    {css href="__CSS__/ionicons.min.css" /}
    <!-- Custom style -->
    {css href="__CSS__/application.css" /}

    <style type="text/css">
        .form-control{
            padding: .375rem;
        }

        #final_total_text{
            border: 3px solid #ced4da;
            height: 70px;
            line-height: 70px;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <form id="stagingForm">
            <input type="hidden" name="id" id="id" value="{$data.id|default=''}">
            <input type="hidden" name="type" id="type" value="{$type|default=''}">
            <input type="hidden" name="invoice_total" id="invoice_total" value="">
            <div class="card-body">
                <div class="row pt-2">
                    <div class="col-xs-12 col-md-6">
                        <h5 class="text-primary">發票資料</h5>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="invoice_id">編號：</label>
                            <div class="col-md-7">
                                <select name="invoice_id" id="invoice_id" class="form-control" >
                                    <option value="{$data.invoice_id|default=''}">{$data.invoice_no|default=''}</option>
                                </select>
<!--                                <input class="form-control" type="hidden" id="invoice_id" name="invoice_id" value="{$data.invoice_id|default=''}" required>-->
<!--                                <input class="form-control" type="text" id="invoice_no" value="{$data.invoice_no|default=''}" required>-->
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="staging_time">日期：</label>
                            <div class="col-md-7">
                                <input type="datetime" class="form-control filed-date" id="staging_time" name="staging_time" value="{$data.staging_time|default=''}" required>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="store_id">店鋪：</label>
                            <div class="col-md-7">
                                <select name="store_id" id="store_id" class="form-control">
                                    <option value=""></option>
                                    {volist name="storeArr" id="store"}
                                    {eq name="store.id" value="$data.store_id|default=''"}
                                    <option value="{$store.id}" selected>{$store.name}</option>
                                    {else/ }
                                    <option value="{$store.id}">{$store.name}</option>
                                    {/eq}
                                    {/volist}
                                </select>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label">銷售員：</label>
                            <div class="col-md-7">
                                <a title="選擇銷售員" onclick="sellers()" class="btn btn-primary btn-sm " href="#">選擇</a>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label"></label>
                            <div class="col-md-7">
                                <div class="consultant"></div>
                                <div class="beautician">
                                    {notempty name="sellers"}
                                    {volist name="sellers" id="val" key="index"}
                                        <div class="seller">
                                            <input type="hidden" class="sellers" value="{$val.seller_id}">
                                            <input type="hidden" name="seller[{$index}][id]" value="{$val.id}">
                                            <input type="hidden" name="seller[{$index}][package_staging_id]" value="{$val.package_staging_id}">
                                            <input type="hidden" name="seller[{$index}][seller_id]" value="{$val.seller_id}">{$val.seller_name}
                                        </div>
                                    {/volist}
                                    {/notempty}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-12 col-md-6">
                        <h5 class="text-primary">會員資料</h5>

                        <div class="form-group row">
                            <div class="col-md-3">
                                <a class="btn btn-default" onclick="new_member()" href="#">新增會員</a>
                            </div>
                            <div class="col-md-7">
                                <input type="checkbox" name="new_customer" {if condition="isset($data.new_customer) && $data.new_customer = 1"} checked="" {/if} value="1">新客
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="member_id">編號：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="hidden" id="member_id" name="member_id" value="{$member.id|default=''}" required>
                                <input class="form-control" type="text" id="member_no" value="{$member.member_no|default=''}" required>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="name">名稱：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="text" id="name" value="{$member.first_name|default=''}" readonly="">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="phone">電話：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="text" id="phone" value="{$member.phone_mobile|default=''}" readonly="">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="store">儲值：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="text" id="store" value="{$member.store|default='0.0'}" readonly="">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-3 control-label" for="reward">獎賞：</label>
                            <div class="col-md-7">
                                <input class="form-control" type="text" id="reward" value="{$member.reward|default='0.0'}" readonly="">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row pt-2">
                    <div class="col-xs-12 col-md-8">

                        <table width="100%">
                            <tr bgcolor="#ced4da">
                                <td colspan="9">
                                    <a title="刪除" onclick="del()" class="btn btn-default btn-sm " href="#">刪除</a>

                                    <a title="舊分期" onclick="old_package_item()" class="btn btn-default btn-sm " href="#" id="old_item">舊分期</a>

                                    <a title="服務套票"  onclick="service_packages()" class="btn btn-default btn-sm " href="#" id="package_item">服務套票</a>

                                    <input type="hidden" name="total" id="total" value="{$data.total|default='0.0'}">
                                    <input type="hidden" class="items_count" value="{$data.items_count|default='0'}">
                                </td>
                            </tr>

                            <tr bgcolor="#e9ecef">
                                <th width="5%"></th>
                                <th width="5%"></th>
                                <th width="12%">編號</th>
                                <th width="20%">名稱</th>
                                <th width="10%">數量</th>
                                <th width="12%">單價</th>
                                <th width="12%">折扣</th>
                                <th width="12%">金額</th>
                                <th width="12%">此期付款</th>
                            </tr>

                            <tr bgcolor="#ced4da" id="service_package" {empty name="inv_items.service_packages"} class="hidden" {/empty}>
                                <td colspan="9" class="border-b-double">
                                    <label id="staging_title">服務套票</label>
                                </td>
                            </tr>

                            {notempty name="items"}
                            {volist name="items" id="val" key="index"}
                                <tr class="border-b service">
                                    <td width="5%" align="center" data-id="{$val.id}">
                                        <input type="checkbox" class="checkbox" value="{$index}">
                                        <input type="hidden" class="service_packages" value="{$val.service_package_id}">
                                    </td>
                                    <td width="5%">
                                        <input type="hidden" name="service[{$index}][id]" value="{$val.id}">
                                        <input type="hidden" name="service[{$index}][package_staging_id]" value="{$val.package_staging_id}">
                                        <input type="hidden" name="service[{$index}][service_package_id]" value="{$val.service_package_id}">
                                        <input type="hidden" name="service[{$index}][package_value]" value="{$val.package_value}" class="package_value">
                                        <input type="hidden" name="service[{$index}][package_unit]" value="{$val.package_unit}">
                                    </td>
                                    <td width="12%">{$val.code}</td>
                                    <td width="20%">{$val.name}</td>
                                    <td width="10%">
                                        <input type="number" min="1" name="service[{$index}][quantity]" value="{$val.quantity}" class="form-control text-right quantity" style="width: 100%;">
                                    </td>
                                    <td width="12%">
                                        <input type="text" name="service[{$index}][price]" value="{$val.price}" class="form-control text-right price" style="width: 100%;">
                                    </td>
                                    <td width="12%">
                                        <input type="text" name="service[{$index}][discount]" value="{$val.discount}" class="form-control text-right discount" style="width: 100%;">
                                    </td>
                                    <td width="12%">
                                        <input type="text" name="service[{$index}][total]" value="{$val.total}" class="form-control text-right total" style="width: 100%;" readonly="">
                                    </td>
                                    <td width="12%">
                                        <input type="text" name="service[{$index}][current_payment]" value="{$val.current_payment}" class="form-control text-right current_payment" style="width: 100%;">
                                    </td>
                                </tr>
                            {/volist}
                            {/notempty}

                            <tr bgcolor="#ced4da" id="member">
                                <td colspan="9" class="border-b-double">
                                    <label>會員增值</label>
                                </td>
                            </tr>

                            <tr bgcolor="#e9ecef">
                                <td width="5%"></td>
                                <td width="5%"></td>
                                <td width="12%"></td>
                                <td width="20%">儲值</td>
                                <td width="10%"></td>
                                <td width="12%">
                                    <input class="form-control" id="member_store" type="text" name="member_store" value="{$data.member_store|default='0.0'}" style="width: 100%; text-align: right;">
                                </td>
                                <td width="12%"></td>
                                <td width="12%">
                                    <span class="member_store">{$data.member_store|default='0.0'}</span>
                                </td>
                                <td width="12%"></td>
                            </tr>

                            <tr bgcolor="#e9ecef">
                                <td width="5%"></td>
                                <td width="5%"></td>
                                <td width="10%"></td>
                                <td width="20%">獎賞</td>
                                <td width="10%"></td>
                                <td width="12%">
                                    <input class="form-control member_reward" type="text" name="member_reward" value="{$data.member_reward|default='0.0'}" style="width: 100%; text-align: right;">
                                </td>
                                <td width="12%"></td>
                                <td width="12%"></td>
                                <td width="12%"></td>
                            </tr>

                            <tr>
                                <td width="5%"></td>
                                <td width="5%"></td>
                                <td width="10%"></td>
                                <td width="20%"></td>
                                <td width="10%"></td>
                                <td width="12%"></td>
                                <td width="12%"></td>
                                <td width="12%"></td>
                                <td width="12%"></td>
                            </tr>

                            <tr>
                                <td colspan="2">
                                    <label class="control-label">備注：</label>
                                </td>

                                <td colspan="5">
                                    <textarea class="form-control" name="notes" id="notes">{$data.notes|default=''}</textarea>
                                </td>
                                <td>
                                    <a title="選擇備注" onclick="notes()" class="btn btn-primary btn-sm" href="#">選擇</a>
                                </td>
                                <td></td>
                            </tr>
                        </table>
                    </div>

                    <div class="col-xs-12 col-md-4">
                        <div class="border">
                            <input type="hidden" name="final_total" id="final_total" value="{$data.final_total|default='0.0'}">
                            <input type="hidden" name="final_totals" id="final_totals" value="{$data.final_totals|default='0.0'}">
                            <div id="final_total_text">
                                {if condition="isset($data.final_total) && $data.final_total > 0"}
                                    尚欠：${$data.final_total}
                                {/if}
                            </div>
                            <div class="total_amount d-flex justify-content-between g-mb-20 g-pa-5">
                                <span>總金額：</span>
                                <strong><h5 id="h5">${$data.total_amount|default='0.0'}</h5></strong>
                                <input type="hidden" name="total_amount" id="total_amount" value="{$data.total_amount|default='0.0'}">

                            </div>

                            <div class="row g-pa-5">
                                <label class="col-md-7">付款方式：</label>
                                <label class="col-md-5">現付金額：</label>
                            </div>

                            <div class="row g-pa-5">
                                <div class="col-md-7">
                                    <input type="hidden" name="payment[0][id]" value="{$payments[0]['id']|default=''}">
                                    <input type="hidden" name="payment[0][package_staging_id]" value="{$payments[0]['package_staging_id']|default=''}">
                                    <select class="form-control method1" name="payment[0][method]" style="display: none; width: 100%;">
                                        <option value="{$payments[0]['method']|default=''}">{$payments[0]['payment_method']|default=''}</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <input type="text" name="payment[0][amount]" class="form-control text-right payment_amount amount1" value="{$payments[0]['amount']|default=''}">
                                </div>
                            </div>
                            <div class="row g-pa-5">
                                <div class="col-md-7">
                                    <input type="hidden" name="payment[1][id]" value="{$payments[1]['id']|default=''}">
                                    <input type="hidden" name="payment[1][package_staging_id]" value="{$payments[1]['package_staging_id']|default=''}">
                                    <select class="form-control method2" name="payment[1][method]" style="display: none; width: 100%;">
                                        <option value="{$payments[1]['method']|default=''}">{$payments[1]['payment_method']|default=''}</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <input type="text" name="payment[1][amount]" class="form-control text-right payment_amount amount2" value="{$payments[1]['amount']|default=''}">
                                </div>
                            </div>
                            <div class="row g-pa-5">
                                <div class="col-md-7">
                                    <input type="hidden" name="payment[2][id]" value="{$payments[2]['id']|default=''}">
                                    <input type="hidden" name="payment[2][package_staging_id]" value="{$payments[2]['package_staging_id']|default=''}">
                                    <select class="form-control method3" name="payment[2][method]" style="display: none; width: 100%;">
                                        <option value="{$payments[2]['method']|default=''}">{$payments[2]['payment_method']|default=''}</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <input type="text" name="payment[2][amount]"  class="form-control text-right payment_amount amount3" value="{$payments[2]['amount']|default=''}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xs-12 col-md-12 col-lg-12">
                    <div class="row pt-2">
                        <div class="col-lg-12" align="center">
                            <button class="btn flat btn-info btn-sm submit">
                                <i class=" fa fa-file-alt"></i>
                                存儲
                            </button>

                            <button class="btn btn-default btn-sm btn-close">
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</body>
<script type="text/javascript">
    let id = $("#id").val();
    if(id.length == 0){
         //页面一打开就执行弹层
        layer.ready(function(){
            layer.open({
                closeBtn:0,
                content: '請選擇分期類型'
                ,btn: ['首次分期', '付款']
                ,yes: function(index, layero){
                    //按钮【按钮一】的回调
                    //如果你想关闭最新弹出的层，直接获取layer.index即可
                    //它获取的始终是最新弹出的某个层，值是由layer内部动态递增计算的
                    // document.title = '首次分期';
                    parent.layer.title('首次分期', index);
                    parent.$("#staging_title").text('首次分期');
                    $('#invoice_id').attr('disabled',true);
                    $('#old_item').hide();
                    layer.close(layer.index);
                }
                ,btn2: function(index, layero){
                    //按钮【按钮二】的回调
                    // document.title = '付款';
                    parent.layer.title('付款', index);
                    parent.$("#staging_title").text('付款');
                    $('#package_item').hide();
                    layer.close(layer.index);
                    //return false 开启该代码可禁止点击该按钮关闭
                }
                ,cancel: function(){
                    //右上角关闭回调
                    // 开启该代码可禁止点击该按钮关闭
                    // return false;
                }
            });
        });
    }


    function del(){
        let id = 0;
        let list = [];
        $(".checkbox:checked").each(function(){
            id = $(this).parent('td').attr('data-id');

            if(id){
                list.push(id);
            }

            $(this).parents('tr').remove();

        })
        if(list.length > 0){
            $.ajax({
                url: "{:url('del_item')}",
                data: {ids: list},
                type: "POST",
                success(res){

                    total();
                }
            })
        }
    }

    function new_member(){
        let url = "{:url('members/add')}";

        let index = parent.layer.getFrameIndex(window.name); //获取窗口索引
        parent.layer.close(index);

        parent.location.href = url;
    }

    function sellers(){
        let ids = [];
        $(".sellers").each(function(){
            ids.push($(this).val());
        });

        layer.open({
            type: 2,
            title: '銷售員',
            area: ['800px', '500px'],
            content: '{:url("users/users?from_panel=invoices&ids=")}' + ids
        })
    }

    function notes(){
        layer.open({
            type: 2,
            title: '備注',
            area: ['800px', '500px'],
            content: '{:url("mappings/mappings?from_panel=invoices&type_id=notes")}'
        })
    }

    function service_packages(){
        let ids = [];
        $(".service_packages").each(function(){
            ids.push($(this).val());
        });
        // alert(ids);
        let member_id = $("#member_id").val();
        if (member_id) {
            layer.open({
                type: 2,
                title: '服務套票',
                area: ['800px', '500px'],
                content: '{:url("service_packages/service_packages?from_panel=package_staging&ids=")}' + ids
            })
        }
    }

    //舊分期
    function old_package_item() {
        let invoice_id = $("#invoice_id").val();
        let member_id = $("#member_id").val();
        layer.open({
            type: 2,
            title: '舊分期',
            area: ['800px', '500px'],
            content: '{:url("PackageStagings/old_package_staging?type=old&member_id=")}' + member_id + '&invoice_id=' + invoice_id
        })
    }


    //計算服務套票、產品、產品組合總價
    function total(){
        let amount = 0.0;
        let total = 0.0;
        let invoice_total = 0.0;
        let quantity, price, discount, current_payment;
        $(".total").each(function () {

            quantity = parseFloat($(this).parent().siblings().children('.quantity').val());
            price = parseFloat($(this).parent().siblings().children('.price').val());
            discount = parseFloat($(this).parent().siblings().children('.discount').val());
            current_payment = parseFloat($(this).parent().siblings().children('.current_payment').val());


            amount = parseFloat(price * quantity - discount);
            if(isNaN(current_payment)) {
                current_payment = 0.0;
            }
            total += parseFloat(current_payment);
            invoice_total += parseFloat(price * quantity - discount);
            $(this).val(amount.toFixed(1));
        });

        $("#total").val(total.toFixed(1));
        $("#invoice_total").val(invoice_total.toFixed(1));
        total_amount();
    }

    //計算應付總價
    function total_amount(){
        let total_amount = 0.0;
        let final_total = 0.0;
        //
        // //可抵扣
        // let store = parseFloat($("#store").val());
        // let reward = parseFloat($("#reward").val());

        //需支付
        let total = parseFloat($("#total").val());
        let member_store = parseFloat($("#member_store").val());

        total_amount = parseFloat(total + member_store);
        final_total = total_amount;

        // //獎賞 > 應付
        // if(reward > final_total){
        //     final_total = 0.0;
        //     reward -= final_total;
        // //獎賞 < 應付
        // }else{
        //     final_total -= reward;
        //     reward = 0.0;
        //     //儲值 > 應付
        //     if (store > final_total) {
        //         final_total = 0.0;
        //         store -= final_total;
        //     //儲值 < 應付
        //     }else{
        //         final_total -= store;
        //         store = 0.0;
        //     }
        // }
        $("#final_total").val(final_total.toFixed(1));
        $("#final_totals").val(final_total.toFixed(1));
        $("#final_total_text").text('應付：$'+final_total.toFixed(1));

        $("#total_amount").val(total_amount.toFixed(1));
        $("#h5").text('$'+total_amount.toFixed(1));

        payment_amount();
    }

    //計算剩余待支付金額
    function payment_amount(){
        let amount1 = $(".amount1").val();
        let amount2 = $(".amount2").val();
        let amount3 = $(".amount3").val();
        let total_amount = $("#total_amount").val();
        // console.log(amount1+', '+amount2+', '+amount3+', '+total_amount);
        let amount = 0.0;


        if (amount1) {
            amount1 = parseFloat(amount1);
        }else{
            amount1 = 0.0;
        }

        if (amount2) {
            amount2 = parseFloat(amount2);
        }else{
            amount2 = 0.0;
        }

        if (amount3) {
            amount3 = parseFloat(amount3);
        }else{
            amount3 = 0.0;
        }

        amount = parseFloat(amount1 + amount2 + amount3);

        total_amount = total_amount - amount;
        if (total_amount > 0) {
            $("#final_totals").val(total_amount.toFixed(1));
            $("#final_total_text").text('尚欠：$'+total_amount.toFixed(1));
        }
        else if (total_amount < 0) {
            $("#final_totals").val(total_amount.toFixed(1));
            $("#final_total_text").text('找贖：$'+Math.abs(total_amount).toFixed(1));
        }
        else if (total_amount == 0) {
            $("#final_totals").val(total_amount.toFixed(1));
            $("#final_total_text").text('');
        }
    }

    $(document).ready( function (){
        let type = $("#type").val();
        if(type === 'edit') {
            $('#package_item').hide();
        }
        initPaymentMethod();
        function initPaymentMethod(){
            $.ajax({
                url: "{:url('mappings/option')}",
                data: {type_id: 'payment_method'},
                dataType: 'json',
                success(res){
                    $(".method1").select2({
                        placeholder: "请选择", //默认input 文字
                        data: res.results,
                    })
                    $(".method2").select2({
                        placeholder: "请选择", //默认input 文字
                        data: res.results,
                    })
                    $(".method3").select2({
                        placeholder: "请选择", //默认input 文字
                        data: res.results,
                    })
                }
            })
        }

        $("#staging_time").daterangepicker({
            "singleDatePicker": true,
            "timePicker": true,
            "timePicker24Hour": true,
            "timePickerSeconds": true,
            "startDate": $("#staging_time").val() ? $("#staging_time").val() : moment().format("YYYY-MM-DD HH:mm:ss"),
            "locale": {
                "format": "YYYY-MM-DD HH:mm:ss",
            }
        }).on('apply.daterangepicker', function(ev, picker) {
            // console.log(picker.startDate.format('YYYY-MM-DD HH:mm:ss'));
            $("#staging_time").val(picker.startDate.format('YYYY-MM-DD HH:mm:ss'))
        });

        $(document).on("change", "#invoice_id", function () {
            let nodes = '';
            let invoice_id = $(this).val();
            let member_id = $("#member_id").val();
            let params = {};
            params['invoice_id'] = invoice_id;
            if (member_id) {
                params['member_id'] = member_id;
            }
            $.ajax({
                // url: "{:url('invoices/find_invoice')}",
                url: "{:url('package_stagings/get_package')}",
                data: params,
                success(res){
                    if(res){
                        // let invoice = res.invoice;
                        // $("#invoice_id").val(invoice.id);
                        // $("#invoice_no").val(invoice.invoice_no);
                        // $('#invoice_id').empty();
                        $.each(res.rows,function (index,element) {
                            nodes += '<tr class="border-b service">  \n' +
                                '    <td width="5%" align="center" data-id="">  \n' +
                                '       <input type="checkbox" class="checkbox" value="' + index + '">  \n' +
                                '       <input type="hidden" class="service_packages" value="' + element.id + '">  \n' +
                                '   </td> <td width="5%">   \n' +
                                '       <input type="hidden" name="service[' + index + '][service_package_id]" value="' + element.sp_id + '">    \n' +
                                '       <input type="hidden" name="service[' + index + '][package_value]" value="' + element.package_value + '" class="package_value"> \n' +
                                '       <input type="hidden" name="service[' + index + '][package_unit]" value="' + element.package_unit + '"> \n' +
                                '   </td>  \n' +
                                '   <td width="12%">' + element.code + '</td>   \n' +
                                '   <td width="20%">' + element.sp_name + '</td>   \n' +
                                '   <td width="10%">  \n' +
                                '       <input type="number" min="1" name="service[' + index + '][quantity]" value="'+element.quantity+'" class="form-control text-right quantity" style="width: 100%;">  \n' +
                                '   </td>   \n' +
                                '   <td width="12%">  \n' +
                                '       <input type="text" name="service[' + index + '][price]" value="' + element.price + '" class="form-control text-right price" style="width: 100%;">  \n' +
                                '   </td>   \n' +
                                '   <td width="12%">  \n' +
                                '       <input type="text" name="service[' + index + '][discount]" value="0.0" class="form-control text-right discount" style="width: 100%;">  \n' +
                                '   </td>   \n' +
                                '   <td width="12%">  \n' +
                                '       <input type="text" name="service[' + index + '][total]" value="' + element.total + '" class="form-control text-right total" style="width: 100%;" readonly="">  \n' +
                                '   </td>  \n' +
                                '   <td width="12%">  \n' +
                                '       <input type="text" name="service[' + index + '][current_payment]" value="" class="form-control text-right current_payment" style="width: 100%;">  \n' +
                                '   </td>   \n' +
                                '   </tr>';
                        });
                        $('#member').before(nodes);
                    }else{
                        layer.tips(res.msg, '#invoice_no', {
                            tips: 3
                        });
                    }
                }
            })
        });

        $(document).on("input propertychange", "#member_no", function () {
            let member_no = $(this).val();
            $.ajax({
                url: "{:url('members/find_member')}",
                data: {member_no: member_no},
                success(res){
                    if(res.member){
                        let member = res.member;
                        $("#member_id").val(member.id);
                        $("#member_no").val(member.member_no);
                        $("#name").val(member.first_name);
                        $("#phone").val(member.phone_mobile);

                        if (member.no_service) {
                            layer.tips('這個會員沒有任何可使用的套票', '#member_no', {
                                tips: 3
                            });
                        }
                        let nodes = '<option value=""></option>';
                        $('#invoice_id').empty();
                        $.each(res.invoices,function (index,element) {
                            nodes += '<option value="'+element.id+'">'+element.invoice_no+'</option>';
                        });
                        $('#invoice_id').append(nodes);
                    }else{
                        $("#member_id").val('');
                        $("#name").val('');
                        $("#phone").val('');
                    }
                }
            })
        });
        

        $(document).on("input propertychange", ".quantity", function () {
            total();
        });
        $(document).on("input propertychange", ".price", function () {
            total();
        });
        $(document).on("input propertychange", ".discount", function () {
            total();
        });
        $(document).on("input propertychange", ".current_payment", function () {
            total();
        });
        
        $(document).on("input propertychange", ".payment_amount", function () {
            payment_amount();   
        });

        $(document).on("input propertychange", "#member_store", function () {
            total_amount();
        });

        
        $(".submit").click(function(){
            let final_totals = $("#final_totals").val();
            if (final_totals > 0) {
                layer.msg('請付清賬單！');
                return false;
            }

            let url = '{:url("packageStagings/add")}';

            let id = $("#id").val();
            if (id) {
                url = '{:url("packageStagings/edit?id=")}' + id
            }

            let params = $("#stagingForm").serialize();  
            
            $.ajax({
                url: url,
                data: params,
                type: "POST",
                success(res){
                    if(res.code == 200){
                        parent.$('#package_stagings-grid').bootstrapTable('refresh');
                        //注意：parent 是 JS 自带的全局对象，可用于操作父页面
                        let index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                        parent.layer.close(index);
                    }
                }
            })
        });

        $(".btn-close").click(function(){
            let index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
        });
        
    })
</script>
</html>