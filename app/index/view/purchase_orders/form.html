{extend name='public/layer_base' /}
{block name='content'}

<section class="content">
        <div>
            <form class="form-horizontal" id="purchase_order-form" method="post" action="{$act}">

            <input type="hidden" id="id" name="id" value="{$item.id|default=''}">
            <input type="hidden" id="supplier_id" name="supplier_id" value="{$item.supplier_id|default=''}">
            <div class="row pt-2">
                <div class="col-xs-12 col-md-4">
                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="purchase_order_no">採購訂單號</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="purchase_order_no" name="purchase_order_no"
                                   value="{$data.purchase_order_no|default=''}"
                                   placeholder="auto assign later">
                        </div>
                    </div>


                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="created_at">創建日期</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="created_at" name="created_at"
                                   value="{$data.created_at|default=''}"
                                   placeholder="2019-11-12">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="payment_term">付款條件</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="payment_term" name="payment_term"
                                   value="{$data.payment_term|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="account_id"> 帳戶</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="account_id"
                                   name="account_id"
                                   value="{$data.account_id|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="supplier_phone">供應商電話</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="supplier_phone"
                                   name="supplier_phone"
                                   value="{$data.supplier_phone|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="from_user">銷售代表</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="from_user"
                                   name="from_user"
                                   value="{$data.from_user|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="from_fax">傳真</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="from_fax"
                                   name="from_fax"
                                   value="{$data.from_fax|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="attn_to">交付給</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="attn_to"
                                   name="attn_to"
                                   value="{$data.attn_to|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="port_of_delivery">交貨港</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="port_of_delivery"
                                   name="port_of_delivery"
                                   value="{$data.port_of_delivery|default=''}"
                                   placeholder="">
                        </div>
                    </div>
                </div>


                <div class="col-xs-12 col-md-4">
                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="revision_no">修訂</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="revision_no" name="revision_no"
                                   value="{$data.revision_no|default=''}"
                                   placeholder="0">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="delivery_date">交貨期</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="delivery_date" name="delivery_date"
                                   value="{$data.delivery_date|default=''}"
                                   placeholder="">
                        </div>
                    </div>


                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="default_currency">貨幣</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="default_currency" name="default_currency"
                                   value="{$data.default_currency|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="contact_id">接觸</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="contact_id" name="contact_id"
                                   value="{$data.contact_id|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="supplier_fax">供應商傳真</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="supplier_fax" name="supplier_fax"
                                   value="{$data.supplier_fax|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="from_phone">指定</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="from_phone" name="from_phone"
                                   value="{$data.from_phone|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="from_mobile">移動</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="from_mobile" name="from_mobile"
                                   value="{$data.from_mobile|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="delivery_phone">送貨電話</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="delivery_phone" name="delivery_phone"
                                   value="{$data.delivery_phone|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="shipped_by">發貨人</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="shipped_by" name="shipped_by"
                                   value="{$data.shipped_by|default=''}"
                                   placeholder="">
                        </div>
                    </div>
                </div>


                <div class="col-xs-12 col-md-4">
                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="category">地位</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="category" name="category"
                                   value="{$data.category|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="cc">C.C.</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="cc" name="cc"
                                   value="{$data.cc|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="supplier_address">供應商地址</label>
                        <div class="col-md-7">
                                <textarea class="form-control" id="supplier_address" name="supplier_address"
                                          size="1" value=""
                                          placeholder="{$data.supplier_address|default=''}"></textarea>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="from_email">郵箱</label>
                        <div class="col-md-7">
                            <input class="form-control" type="email" id="from_email" name="from_email"
                                   value="{$data.from_email|default=''}"
                                   placeholder="">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="from_primary_address">地址</label>
                        <div class="col-md-7">
                                 <textarea class="form-control" id="from_primary_address" name="from_primary_address"
                                           size="1"
                                           value=""
                                           placeholder="{$data.from_primary_address|default=''}"></textarea>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="delivery_address">送貨地址</label>
                        <div class="col-md-7">
                                <textarea class="form-control" id="delivery_address" name="delivery_address"
                                          size="1"
                                          value=""
                                          placeholder="{$data.delivery_address|default=''}"></textarea>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 control-label" for="forwarder">貨代</label>
                        <div class="col-md-7">
                            <input class="form-control" type="text" id="forwarder"
                                   name="forwarder"
                                   value="{$data.forwarder|default=''}"
                                   placeholder="">
                        </div>
                    </div>


                </div>
            </div>

     <!--           <div class="table-responsive g-mb-40 ">
                    <table class="table u-table&#45;&#45;v3&#45;&#45;bordered g-color-black">
                        <thead >
                        <tr >
                            <th class="text-center">項目</th>
                            <th class="text-center">說明</th>
                            <th class="text-center">總計(HKD)</th>
                            <th>
                                <a class="js-edit u-link-v5 g-color-gray-light-v6 g-color-secondary&#45;&#45;hover"
                                   href="#">
                                    <i class="fa fa-plus" id="add-line"></i>
                                </a>
                            </th>
                        </tr>
                        </thead>

                        <tbody id="tbody">
                        {empty name="pur_items"}
                        <tr>
                            <input type="hidden" name="item[0][id]">
                            <td><input class="form-control" type="text" name="item[0][name]"></td>
                            <td><input class="form-control" type="text" name="item[0][description]"></td>
                            <td><input class="form-control amount" type="text" name="item[0][amount]"></td>
                            <td>
                                <a class="u-link-v5 g-color-gray-light-v6 g-color-secondary&#45;&#45;hover g-text-underline&#45;&#45;none&#45;&#45;hover"
                                   href="#">
                                    <i class="fa fa-minus"></i>
                                </a>
                            </td>
                        </tr>
                        {else/}
                        {foreach name="pur_items" id="items" key="key"}
                        <tr>
                            <input type="hidden" name="item[{$key}][id]" value="{$items.id}">
                            <td><input class="form-control" type="text" name="item[{$key}][name]"
                                       value="{$items.name}"></td>
                            <td><input class="form-control" type="text" name="item[{$key}][description]"
                                       value="{$items.description}"></td>
                            <td><input class="form-control amount" type="text" name="item[{$key}][amount]"
                                       value="{$items.amount}"></td>
                            <td>
                                <a class="u-link-v5 g-color-gray-light-v6 g-color-secondary&#45;&#45;hover g-text-underline&#45;&#45;none&#45;&#45;hover"
                                   href="#">
                                    <i class="fa fa-minus"></i>
                                </a>
                            </td>
                        </tr>
                        {/foreach}
                        {/empty}
                        </tbody>
                    </table>
                </div>
-->

                <div class="form-group ">
                    <p><a title="選擇" onclick="service_products()" class="btn btn-primary btn-sm " href="#">選擇</a></p>

                    <table id="service_products" class="table table-hover table-striped table-sm datatable" width="100%">
                        <thead>
                        <th width="5%"><input type="checkbox" name=""></th>
                        <th width="5%">次序</th>
                        <th>編號</th>
                        <th>名稱</th>
                        <th width="15%">售價</th>
                        <th width="15%">數量</th>
                        <th width="15%">金額</th>

                        </thead>
                        <tbody>
                        {empty name="pur_items" }
                        {notempty name="service_product"}
                        {volist name="service_product" id="cp" key="key"}
                        <tr>
                            <input type="hidden" name="item[{$key}][product_id]" value="{$cp.product_id}">
                            <td width="5%"><input type="checkbox" name=""></td>
                            <td width="5%"><input type="number" name="item[{$key}][ordering]" value="{$cp.ordering}"style="width: 50%;"></td>
                            <td>{$cp.product_code}</td>
                            <td>{$cp.product_name}</td>
                            <td width="15%"><input type="number" class="product_price" name="item[{$key}][product_price]" value="{$cp.product_price}"style="width: 100%;"></td>
                            <td width="15%"><input type="number" class="quantity" name="item[{$key}][quantity]" value="{$cp.quantity}"style="width: 100%;"></td>
                            <td width="15%"><input class="amount" type="number" name="item[{$key}][amount]"  value="{$cp.amount}" style="width: 100%;"></td>
                        </tr>
                        {/volist}
                        {/notempty}
                        {/empty}
                        </tbody>
                    </table>
                </div>

                <div class="card-body">
                    <form class="form-horizontal" action="lyear_forms_elements.html" method="post"
                          onsubmit="return false;">

                        <!-- Columns start at 50% wide on mobile and bump up to 33.3% wide on desktop -->
                        <div class="row p-t-15">
                            <div class="col-xs-12 col-md-6">

                                <div class="form-group row">
                                    <label class="col-md-3 control-label" for="total">總計:</label>
                                    <div class="col-md-7">
                                        <input class="form-control" type="text" id="total" name="total"
                                               value="{$data.total|default=''}"
                                               placeholder="0.0">
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-md-3 control-label" for="total_discount">特別折扣 (%):</label>
                                    <div class="col-md-7">
                                        <input class="form-control" type="text" id="total_discount" name="total_discount"
                                               value="{$data.total_discount|default=''}"
                                               placeholder="0.0">
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-md-3 control-label" for="deduction">
                                        特別折扣金額 :</label>
                                    <div class="col-md-7">
                                        <input class="form-control" type="text" id="deduction" name="deduction"
                                               value="{$data.deduction|default=''}"
                                               placeholder="0.0">
                                    </div>
                                </div>
                            </div>


                            <div class="col-xs-12 col-md-6">
                                <div class="form-group row">
                                    <label class="col-md-3 control-label" for="tax_rate">稅率(%):</label>
                                    <div class="col-md-7">
                                        <input class="form-control" type="text" id="tax_rate"
                                               name="tax_rate"
                                               value="{$data.tax_rate|default=''}"
                                               placeholder="0.0">
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-md-3 control-label" for="final_total">淨額:</label>
                                    <div class="col-md-7">
                                        <input class="form-control" type="text" id="final_total"
                                               name="final_total"
                                               value="{$data.final_total|default=''}"
                                               placeholder="0.0">
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="card-body">
                            <form class="form-horizontal" action="lyear_forms_elements.html" method="post"
                                  onsubmit="return false;">

                                <!-- Columns start at 50% wide on mobile and bump up to 33.3% wide on desktop -->
                                <div class="row p-t-15">
                                    <div class="col-xs-12 col-md-12">
                                        <div class="form-group row">
                                            <label class="col-md-1 control-label" for="terms_conditions">條款和條件</label>
                                            <div class="col-md-9">
                        <textarea class="form-control" id="terms_conditions" name="terms_conditions"
                                  size="1"
                                  value=""
                                  placeholder="{$data.terms_conditions|default=''}"></textarea>
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-md-1 control-label" for="terms">添加標準術語</label>
                                            <div class="col-md-9">
                                                <input class="form-control" type="text" id="terms"
                                                       name="terms"
                                                       value="{$data.terms|default=''}"
                                                       placeholder="">
                                            </div>
                                        </div>




                                        <div class="form-group row">
                                            <label class="col-md-1 control-label" for="owner_user_id">安全管理員</label>
                                            <div class="col-md-2">
                                                <select class="form-control" id="owner_user_id" name="owner_user_id" size="1">
                                                    <option value="0">ken kuo</option>
                                                    <option value="1">Admin Adaptive</option>
                                                    <option value="2">Leo Wong</option>
                                                    <option value="3">Luke Tam</option>
                                                    <option value="4">Ron Kaluta</option>
                                                    <option value="5">Rooky lu</option>
                                                    <option value="6">Sandy Ng</option>
                                                    <option value="7">Syatem User</option>
                                                    <option value="8">Tiffany Cheng</option>
                                                </select>
                                            </div>

                                            <label class="col-md-1 control-label" for="assigned_user_id">分配給用戶</label>
                                            <div class="col-md-2">
                                                <select class="form-control" id="assigned_user_id" name="assigned_user_id" size="1">
                                                    <option value="0">Ken Kuo</option>
                                                    <option value="1">Admin Adaptive</option>
                                                    <option value="2">Ken Kuo</option>
                                                    <option value="3">Leo wong</option>
                                                    <option value="4">Luke Tam</option>
                                                    <option value="5">Ron Kaluta</option>
                                                    <option value="6">Rooky lu</option>
                                                    <option value="7">Sandy Ng</option>
                                                    <option value="8">System User</option>
                                                    <option value="9">Tiffany Cheng</option>
                                                </select>
                                            </div>

                                            <label class="col-md-1 control-label" for="visible_for">可見性</label>
                                            <div class="col-md-2">
                                                <select class="form-control" id="visible_for" name="visible_for" size="1">
                                                    <option value="0">授權團隊</option>
                                                    <option value="1">全部</option>
                                                    <option value="2">自己的團隊</option>
                                                    <option value="3">自己</option>
                                                </select>
                                            </div>

                                            <label class="col-md-1 control-label" for="team_id">分配給團隊</label>
                                            <div class="col-md-2">
                                                <select class="form-control" id="team_id" name="team_id" size="1">
                                                    <option value="0">管理員</option>
                                                    <option value="1">行銷</option>
                                                    <option value="2">會員</option>
                                                    <option value="3">銷售額</option>
                                                    <option value="4">培訓</option>
                                                    <option value="5">審判</option>


                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </form>
                </div>
            </form>
        </div>

        <hr>
        <div class="col-md-12" align="center">
            <button id="purchase_order-submit" type="button" class=" far fa-file-alt  btn flat btn-info dataFormSubmit  btn-sm  ">
                保存
            </button>
            &nbsp;
            <button class="btn btn-sm btn-default layer-close">關閉</button>
        </div>

</section>
{/block}

{block name="js"}

<script type="text/javascript">

    function service_products(){
        layer.open({
            type: 2,
            title: 'Products Information',
            area: ['800px', '500px'],
            content: '{:url("products/products?from_panel=service_products")}'
        })
    }

    $("#purchase_order-submit").click(function(){    // 提交按钮触发事件
        var form_action = $("#purchase_order-form").attr("action");    // 获取 表单的 提交地址
        $.post(form_action,$("#purchase_order-form").serialize(),function(data){
            layer.msg(data['msg']);
            if(data['code'] == 200){
                parent.layer.closeAll();
                parent.$('#purchase_order-grid').bootstrapTable('refresh')
            }
        });
    });

    $('.layer-close').on('click', function () {
        parent.layer.closeAll();
    });




    $('.fa-plus').click(function () {
        let node = '';
        let index = $('.table').children('tbody').children('tr').length;
        node += '<tr><input type="hidden" name="item[' + index + '][id]"><td>' +
            '<input class="form-control" type="text" name="item[' + index + '][name]"></td><td>' +
            '<input class="form-control" type="text" name="item[' + index + '][description]"></td><td>' +
            '<input class="form-control amount" type="text" name="item[' + index + '][amount]"></td><td><a class="u-link-v5 g-color-gray-light-v6 g-color-secondary--hover g-text-underline--none--hover" href="#"><i class="fa fa-minus"></i></a></td></tr>';
        $('.table').children('tbody').append(node);
    })

    $(document).on("click", '.fa-minus', function () {
        let len = 0;
        len = $('.table').children('tbody').children('tr').length;
        if (len > 1) {
            $(this).parents('tr').remove();
            total();
        }
    })

    $(document).on("change", ".amount", function () {
        total();
    })

    function total() {
        let total = 0.00;

        $(".amount").each(function () {
            total += parseFloat($(this).val());

            $("#total").val(total.toFixed(2));
        });

        amount();
    }


    $(document).on("change", "#deduction", function () {
        amount();
    });
    $(document).on("input propertychange", ".quantity", function () {
        amount();
    });
    $(document).on("input propertychange", ".product_price", function () {
        amount();
    });


    function amount(){
        let amount = 0.0;
        let total = 0.0;
        let quantity, product_price;
        $(".amount").each(function () {

            quantity = parseFloat($(this).parent().siblings().children('.quantity').val());
            product_price = parseFloat($(this).parent().siblings().children('.product_price').val());
            // total_discount = parseFloat($(this).parent().siblings().children('.amount').val());
            // console.log(quantity,product_price)
            amount = parseFloat(product_price * quantity);
            total += parseFloat(amount);

            $(this).val(amount.toFixed(1));
        });

        $("#total").val(total.toFixed(1));

        final_total();
    }

    function final_total(){
        let total_amount = 0.0;
        let final_total = 0.0;

        $("#final_total").val(final_total.toFixed(1));
        $("#total_amount").val(total_amount.toFixed(1));
        $("#h5").text('$'+total_amount.toFixed(1));

        payment_amount();
    }



</script>
{/block}